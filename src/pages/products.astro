---
export const prerender = true;
import Layout from "../layouts/Layout.astro";
import { supabase } from "../core/lib/supabase";
import { Image } from "astro:assets";
import ProductCard from "../shared/components/ProductCard.astro";

const { data: products } = await supabase
    .from("products")
    .select(`*, categories:category_id (id, name)`)
    .is("deleted_at", null)
    .order("created_at", { ascending: false });

const { data: categories } = await supabase
    .from("categories")
    .select("*")
    .order("name");

const allCategories = categories || [];
const allProducts = products || [];
---

<Layout title="Productos">
    <div class="min-h-screen bg-background font-sans pb-20">
        <div class="bg-primary/5 border-b border-border/50 py-8 md:py-12">
            <div class="container text-center">
                <h1
                    class="font-sans text-4xl md:text-5xl font-bold text-foreground mb-4"
                >
                    Nuestros Productos
                </h1>
                <p class="text-muted-foreground max-w-xl mx-auto">
                    Explora nuestra colección completa de cosméticos y productos
                    de belleza seleccionados para ti.
                </p>
            </div>
        </div>

        <div
            class="container mt-6 md:mt-8 md:grid md:grid-cols-[240px_1fr] gap-6 md:gap-8"
        >
            <aside class="space-y-6 mb-6 md:mb-0">
                <div class="relative">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"
                        ><circle cx="11" cy="11" r="8"></circle><path
                            d="m21 21-4.3-4.3"></path></svg
                    >
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Buscar productos..."
                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 pl-9 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    />
                </div>

                <div>
                    <h3 class="font-semibold mb-3 text-lg">Categorías</h3>
                    <div
                        class="flex flex-row md:flex-col gap-2 md:gap-1 overflow-x-auto pb-4 md:pb-0 -mx-4 px-4 md:mx-0 md:px-0 scrollbar-hide snap-x"
                    >
                        <button
                            data-category="all"
                            class="category-btn whitespace-nowrap shrink-0 text-left px-3 py-2 rounded-md text-sm transition-colors hover:bg-accent hover:text-accent-foreground font-medium bg-secondary text-primary snap-start border border-border/50 md:border-transparent"
                        >
                            Todas
                        </button>
                        {
                            allCategories.map((cat) => (
                                <button
                                    data-category={cat.id}
                                    class="category-btn whitespace-nowrap shrink-0 text-left px-3 py-2 rounded-md text-sm transition-colors hover:bg-accent hover:text-accent-foreground text-muted-foreground snap-start border border-border/50 md:border-transparent"
                                >
                                    {cat.name}
                                </button>
                            ))
                        }
                    </div>
                </div>
            </aside>

            <main>
                <div
                    id="results-count"
                    class="text-sm text-muted-foreground mb-6 hidden"
                >
                    Mostrando resultados para "<span
                        id="search-term-display"
                        class="font-medium text-foreground"></span>"
                </div>

                <div
                    id="product-grid"
                    class="grid grid-cols-2 lg:grid-cols-3 gap-2 md:gap-6"
                >
                    {
                        allProducts.map((product, index) => {
                            return (
                                <div
                                    class="product-item"
                                    data-category={product.category_id}
                                    data-name={product.name.toLowerCase()}
                                >
                                    <ProductCard
                                        product={product}
                                        loading={index < 6 ? "eager" : "lazy"}
                                    />
                                </div>
                            );
                        })
                    }
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden py-20 text-center">
                    <div
                        class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-muted mb-4"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="text-muted-foreground"
                            ><circle cx="11" cy="11" r="8"></circle><path
                                d="m21 21-4.3-4.3"></path></svg
                        >
                    </div>
                    <h3 class="text-lg font-medium text-foreground">
                        No se encontraron productos
                    </h3>
                    <p class="text-muted-foreground">
                        Intenta con otros términos o categoría.
                    </p>
                    <button
                        id="clear-filters"
                        class="mt-4 text-primary hover:underline font-medium"
                    >
                        Limpiar filtros
                    </button>
                </div>
            </main>
        </div>
    </div>
</Layout>

<script>
    function setupFilters() {
        const searchInput = document.getElementById(
            "search-input",
        ) as HTMLInputElement;
        const categoryBtns = document.querySelectorAll(".category-btn");
        const productItems = document.querySelectorAll(".product-item");
        const resultsCount = document.getElementById("results-count");
        const searchTermDisplay = document.getElementById(
            "search-term-display",
        );
        const emptyState = document.getElementById("empty-state");
        const productGrid = document.getElementById("product-grid");
        const clearFiltersBtn = document.getElementById("clear-filters");

        let currentCategory = "all";
        let currentSearch = "";

        // Parse URL params on load
        const urlParams = new URLSearchParams(window.location.search);
        const urlSearch = urlParams.get("buscar");
        const urlCategory = urlParams.get("categoria");

        if (urlSearch) {
            currentSearch = urlSearch.toLowerCase();
            searchInput.value = urlSearch;
        }

        if (urlCategory) {
            currentCategory = urlCategory;
            updateCategoryUI(currentCategory);
        }

        // Initial Filter
        filterProducts();

        // Event Listeners
        searchInput?.addEventListener("input", (e) => {
            currentSearch = (e.target as HTMLInputElement).value.toLowerCase();
            // Update URL without refresh
            const newUrl = new URL(window.location.href);
            if (currentSearch) {
                newUrl.searchParams.set("buscar", currentSearch);
            } else {
                newUrl.searchParams.delete("buscar");
            }
            window.history.replaceState({}, "", newUrl);

            filterProducts();
        });

        categoryBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                const category = btn.getAttribute("data-category");
                if (category) {
                    currentCategory = category;

                    // Update URL without refresh
                    const newUrl = new URL(window.location.href);
                    if (currentCategory !== "all") {
                        newUrl.searchParams.set("categoria", currentCategory);
                    } else {
                        newUrl.searchParams.delete("categoria");
                    }
                    window.history.replaceState({}, "", newUrl);

                    updateCategoryUI(currentCategory);
                    filterProducts();
                }
            });
        });

        clearFiltersBtn?.addEventListener("click", () => {
            currentCategory = "all";
            currentSearch = "";
            searchInput.value = "";
            updateCategoryUI("all");

            // Clean URL
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.delete("buscar");
            newUrl.searchParams.delete("categoria");
            window.history.replaceState({}, "", newUrl);

            filterProducts();
        });

        function updateCategoryUI(activeCat: string) {
            categoryBtns.forEach((btn) => {
                const btnCat = btn.getAttribute("data-category");
                if (btnCat === activeCat) {
                    btn.classList.remove(
                        "text-muted-foreground",
                        "bg-transparent",
                    );
                    btn.classList.add(
                        "bg-secondary",
                        "text-primary",
                        "font-medium",
                    );
                } else {
                    btn.classList.add(
                        "text-muted-foreground",
                        "bg-transparent",
                    );
                    btn.classList.remove(
                        "bg-secondary",
                        "text-primary",
                        "font-medium",
                    );
                }
            });
        }

        function filterProducts() {
            let visibleCount = 0;

            productItems.forEach((item) => {
                const itemCat = item.getAttribute("data-category");
                const itemName = item.getAttribute("data-name");

                const matchesCategory =
                    currentCategory === "all" || itemCat === currentCategory;
                const matchesSearch =
                    !currentSearch ||
                    (itemName && itemName.includes(currentSearch));

                if (matchesCategory && matchesSearch) {
                    item.classList.remove("hidden");
                    visibleCount++;
                } else {
                    item.classList.add("hidden");
                }
            });

            if (visibleCount === 0) {
                productGrid?.classList.add("hidden");
                emptyState?.classList.remove("hidden");
            } else {
                productGrid?.classList.remove("hidden");
                emptyState?.classList.add("hidden");
            }

            // Show Search status
            if (currentSearch && resultsCount && searchTermDisplay) {
                resultsCount.classList.remove("hidden");
                searchTermDisplay.textContent = currentSearch;
            } else if (resultsCount) {
                resultsCount.classList.add("hidden");
            }
        }
    }

    setupFilters();

    document.addEventListener("astro:page-load", setupFilters);
</script>
